---
os: linux
dist: bionic
language: ruby
cache:
  - bundler
before_install:
  - yes | gem update --system --force
  - gem install bundler
  - git clone https://github.com/trombik/build-in-vagrant-box
  - build-in-vagrant-box/bin/before_install.sh
addons:
  apt:
    update: true
    packages:
      - python-pip
      - curl
      - bridge-utils
      - dnsmasq-base
      - ebtables
      - libvirt-bin
      - libvirt-dev
      - qemu-kvm
      - qemu-utils
      - ruby-dev
install:
  - bundle install
rvm:
  - 2.4.9
  - 2.6.5
script:
  - gem build sensu-plugins-http.gemspec
  - gem install sensu-plugins-http-*.gem
  - bundle exec rake quick
  - bundle exec rake kitchen:ruby-`echo $TRAVIS_RUBY_VERSION | sed -e "s/\.//g"`-debian-8
  - export DEST_DIR="dest-`echo ${VAGRANT_BOX} | cut -d'/' -f2`"
  - mkdir ${DEST_DIR}
  - build-in-vagrant-box/bin/up.sh ${VAGRANT_BOX}
  - build-in-vagrant-box/bin/run.sh build.sh "TRAVIS_BRANCH=${TRAVIS_BRANCH} TRAVIS_REPO_SLUG=${TRAVIS_REPO_SLUG}"
  - build-in-vagrant-box/bin/download.sh ${DEST_DIR}
  - ls -alh ${DEST_DIR}
env:
  global:
    - KITCHEN_LOCAL_YAML=.kitchen.travis.yml
  jobs:
    - VAGRANT_BOX=trombik/ansible-freebsd-12.1-amd64
    - VAGRANT_BOX=trombik/ansible-openbsd-6.6-amd64
    - VAGRANT_BOX=trombik/ansible-ubuntu-18.04-amd64
    - VAGRANT_BOX=trombik/ansible-centos-7.4-x86_64
